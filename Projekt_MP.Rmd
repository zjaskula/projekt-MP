---
title: "Predykcja zespołu metabolicznego"
author: "Jaskuła Z., Kozakiewicz K., Miklaszewska N."
date: "`r Sys.Date()`"
output:
  pdf_document:
    toc: true
  word_document:
    toc: true
fontsize: 12pt
bibliography: references.bib
csl: "nowa-audiofonologia.csl"
lang: pl
link-citations: true
---

\newpage

# Wstęp

Zespół metaboliczny jest istotnym wyzwaniem dla zdrowia publicznego i epidemiologii. Został po raz pierwszy opisany w 1981 roku, a jego definicja była wielokrotnie aktualizowana [@kalinowski2016]. Obecna definicja, zaproponowana w artykule *„Zespół metaboliczny — nowa definicja i postępowanie w praktyce”* [@dobrowolski], opracowanym przez polskie towarzystwa medyczne, brzmi następująco:

*definicja*:

:   Rozpoznanie zespołu metabolicznego wymaga obecności otyłości (najczęściej brzusznej) oraz co najmniej dwóch z trzech poniższych czynników: podwyższonego ciśnienia tętniczego, nieprawidłowego metabolizmu glukozy, podwyższonego stężenia cholesterolu frakcji nie-HDL (aterogenna dyslipidemia).

  Nowa definicja jest uproszczoną wersją wcześniejszych, które obejmowały szerszy zakres kryteriów diagnostycznych, m.in. występowanie cukrzycy typu drugiego, insulinooporności, mikroalbuminurii, czy podwyższonego stężenia trójglicerydów w surowicy [@kalinowski2016]. Niezależnie od przyjętej definicji, niezmienne pozostaje stanowisko, że współwystępowanie wymienionych zaburzeń metabolicznych znacząco zwiększa ryzyko rozwoju chorób sercowo-naczyniowych -- w stopniu większym, niż każdy z tych czynników rozpatrywany oddzielnie.

  Obecnie mówi się o zespole metabolicznym jako o epidemii o zasięgu globalnym [@saklayen2018]. Główne przyczyny jego rosnącej częstości to upowszechnienie siedzącego trybu życia oraz nadmierne spożycie wysokokalorycznych pokarmów, co przyczynia się do wzrostu otyłości -- jednego z kluczowych komponentów tego zespołu. W Stanach Zjednoczonych rozpowszechnienie zespołu metabolicznego w populacji dorosłych szacuje się na około 22%, przy czym w grupie pacjentów z cukrzycą typu 2 odsetek ten przekracza 80%. Co istotne, zespół coraz częściej diagnozowany jest również u dzieci i młodzieży, co stanowi poważne wyzwanie dla systemów ochrony zdrowia. Zjawisko to nie ogranicza się jedynie do krajów wysoko rozwiniętych – regiony takie jak Azja, Ameryka Łacińska czy Bliski Wschód odnotowują znaczący wzrost zachorowań, potwierdzając uniwersalny charakter tego zagrożenia zdrowotnego [@saklayen2018].

  Z tego względu kluczowe jest zrozumienie mechanizmów leżących u podstaw zespołu metabolicznego oraz doskonalenie metod jego wczesnej diagnostyki, co może ułatwić skuteczną prewencję powikłań, w tym chorób sercowo-naczyniowych. Ze względu na rozbieżności w definicjach zespołu metabolicznego [@kalinowski2016], opracowanie jednolitego narzędzia analitycznego, które umożliwi wczesną, trafną i zautomatyzowaną identyfikację pacjentów zagrożonych jego wystąpieniem na podstawie danych klinicznych, jest wyjątkowo trudne. Celem niniejszego projektu jest stworzenie modelu predykcyjnego, który, bazując na danych klinicznych pacjentów, umożliwi identyfikację osób spełniających kryteria rozpoznania zespołu metabolicznego.

\bigskip

  **Podział prac w zespole** był następujący:

\begin{tightlist}
1.  Jaskuła Z. -- Przygotowanie i analiza zbioru danych

2.  Kozakiewicz K. --

3.  Miklaszewska N. --.
\end{tightlist}

\newpage

# Przygotowanie i analiza zbioru danych

```{r message=FALSE, warning=FALSE, include=FALSE}
library(vtable) #funkcja st(), zamiast summary()
library(knitr) #funkcja kable() do tabel
library(kableExtra)
library(dplyr) #%>%
library(naniar) #funkcja gg_miss_upset()
library(mice) #funkcja mice()
library(gridExtra) #funkcja grid.arrange()
library(ggcorrplot) #funkcja ggcorrplot()
library(vcd) #funkcja assocstats() - współczynniki kontyngencji
library(lmtest) # testy LR i Walda
library(car) # funkcja vif

#przykładowa paleta kolorów, kolory UG
paleta <- c("#F0F0F0", "#A0DCFA", "#508FE5", "#0041D0", "#052D73")
```

W projekcie wykorzystano dane pochodzące z publicznie dostępnego [[zbioru]{.underline}](https://www.kaggle.com/datasets/antimoni/metabolic-syndrome/data) opublikowanego na platformie Kaggle. Zawiera on zarówno informacje demograficzne, jak i kliniczne dotyczące pacjentów, sklasyfikowanych ze względu na obecność lub brak zespołu metabolicznego. Zbiór zawiera numer identyfikacyjny pacjentów, 9 zmiennych ilościowych oraz 5 zmiennych jakościowych. Umożliwia analizę zależności pomiędzy cechami jednostki a występowaniem schorzenia, co czyni go odpowiednim do zastosowań predykcyjnych. Szczegółowy opis zmiennych przedstawiono w tabeli poniżej:

```{r echo=FALSE, message=FALSE, warning=FALSE}
tabela <- data.frame(
  Zmienna = c("seqn", "Age", "Sex", "Marital", "Income", "Race", "WaistCirc", 
              "BMI", "Albuminuria", "UrAlbCr", "UricAcid", "BloodGlucose",
              "HDL", "Triglycerides", "MetabolicSyndrome"),
  Opis = c("numer identyfikacyjny",
           "wiek badanego (w latach)",
           "płeć badanego (kobieta/mężczyzna)",
           "stan cywilny jednostki",
           "dochód",
           "rasa",
           "pomiar obwodu talii (w cm)",
           "wskaźnik masy ciała",
           "ilość albumin (białek) w moczu (wartości: 0, 1, 2)",
           "stosunek albuminy do kreatyniny w moczu",
           "poziom kwasu moczowego we krwi (w mg/dl)",
           "poziom glukozy we krwi (w mg/dl)",
           "poziom HDL (\"dobrego\" cholesterolu) (w mg/dl)",
           "poziom trójglicerydów we krwi (w mg/dl)",
           "obecność zespołu metabolicznego (0 = brak, 1 = obecność)")
)

kbl(tabela,
  booktabs = TRUE,
  caption = "Opis zmiennych zawartych w zbiorze danych") %>%
  kable_styling(
    latex_options = c("striped", "hold_position")) %>%
  footnote(
    general = "Źródło: opracowanie własne na podstawie zbioru danych",
    general_title = "") %>%
  column_spec(1, width = "4cm")
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# import zbioru danych
dane <- read.table("Metabolic Syndrome.csv",
                      header = TRUE,
                      sep = ",", 
                      dec = ".",
                      stringsAsFactors = TRUE)

# zamiana `Albuminuria` i `MetabolicSyndrome` na zm. jakościowe
dane[c("Albuminuria", "MetabolicSyndrome")] <- 
  lapply(dane[c("Albuminuria", "MetabolicSyndrome")], factor)

# usuwanie zmiennej `seqn`
dane_ms <- dane[-1]

# wyświetlenie statystyk zbiorczych
st(dane_ms,
   out = "kable", digits = 4,
   add.median = TRUE,
   summ.names = c("N", "Średnia", "Odch. Std.", "Min", 
                  "Q1", "Mediana", "Q3", "Max"),
   title = "Statystyki zbiorcze") %>% 
  kable_styling(latex_options = "striped", 
                stripe_index = c(1:3, 6, 13:14, 21:23, 27:32)) %>% 
  footnote(general = "Źródło: opracowanie własne na podstawie zbioru danych",
           general_title = "") 
```

## Statystyki opisowe

Zmiennymi demograficznymi uwzględnionymi w zbiorze są: wiek (`Age`), płeć (`Sex`), stan cywilny (`Marital`), dochód (`Income`) oraz rasa (`Race`). Część kliniczna obejmuje pomiary antropometryczne i wyniki badań laboratoryjnych istotnych w kontekście diagnostyki zespołu metabolicznego.

  Zbiór danych obejmuje 2401 osób (1211 kobiet i 1190 mężczyzn) w wieku od 20 do 80 lat (średnia 48,69 lat). Większość badanych jest w średnim wieku. Wśród uczestników dominują osoby zamężne/żonate (ok. 50%), a rozkład dochodów jest zróżnicowany – od 300 do 9000 jednostek (średnio 4005). Dane obejmują też informacje o przynależności rasowej; największe grupy stanowią osoby białe (933 osób, co stanowi ok. 39% badanych) i czarnoskóre (548, ok. 23%).

  Średni obwód talii wynosi 98,31 cm, przy czym wartości skrajne sięgają od 56,2 cm do 176 cm. Średnia wartość BMI to 28,7, co klasyfikuje przeciętnego badanego jako osobę z nadwagą [@BMI]. 25% badanych ma BMI powyżej 30, co jest klasyfikowane jako otyłość. W zestawie są zarówno osoby z niedowagą (BMI \< 17), jak i ze skrajną otyłością (BMI \> 40).

  Albuminuria to zjawisko, gdy organizm wydala z organizmu białka wraz z moczem. Jest to naturalne, jednak wysokie stężenie albumin w moczu może być objawem nieprawidłowości w pracy nerek, spowodowanej np. cukrzycą lub nieskutecznie leczonym nadciśnieniem tętniczym [@albuminuria]. W zbiorze stężenie białek jest indykatorem o wartościach: 0 - normalne stężenie albumin, 1 - podwyższony poziom, 2 - bardzo wysoki poziom albumin (białkomocz). Osoby z podwyższonym poziomem stanowią mniejszość. W przypadku zmiennej `UrAlbCr` opisującej stosunek albuminy do kreatyniny widać, że posiada ona bardzo duży przedział wartości. Mediana wynosi 7,07, ale występują wartości skrajnie wysokie (maksymalnie 5928), wskazując na obecność odstających obserwacji.

  Poziom kwasu moczowego (`UricAcid`) we krwi wynosi średnio 5,49 mg/dl; około 75% badanych ma wyniki mieszczące się w normie, która wynosi między 3 a 7 mg/dl, w zależności od płci. Podwyższone ilości kwasu moczowego mogą być skutkiem niewłaściwej diety, otyłości lub cukrzycy. Wśród potencjalnych przyczyn wymieniany jest również zespół metaboliczny [@kwas_moczowy].

  Poziom glukozy we krwi (`BloodGlucose`) również pokazuje dużą zmienność – od bardzo niskich do bardzo wysokich wartości – przy medianie 99 mg/dl, co jest wartością prawidłową.

  Średni poziom "dobrego" cholesterolu (`HDL`) wynosi 53,37 mg/dl. Około połowa uczestników ma nieprawidłowy poziom HDL w stosunku do zalecanych norm (zależnie od płci granica nieprawidłowej ilości HDL wynosi między 40-50 mg/dl [@HDL]). Średnie stężenie trójglicerydów (`Triglycerides`) wynosi 128,1 mg/dl, przy czym najwyższe wartości (1562 mg/dl) są znacznie powyżej poziomu bezpiecznego (150-199 mg/dl) [@trojglicerydy].

  Zmienna `MetabolicSyndrome` informuje, że około 34,24% badanych ma już rozpoznany zespół metaboliczny. Dane medyczne zawarte w zbiorze odnoszą się do wyników badań oraz pomiarów, które w przeszłości były uznawane za istotne indykatory zespołu metabolicznego, jak wspomniano powyżej. W ramach niniejszego projektu zostanie przeanalizowane, czy na podstawie tych danych możliwe jest skuteczne przewidywanie występowania zespołu metabolicznego u pacjentów.

## Analiza braków

W zbiorze danych występują braki, które należy zbadać, i w miarę możliwości zniwelować. Z analizy statystyk opisowych wynika, że zmienna `Marital` zawiera 208 obserwacji oznaczonych jako "...". Ponadto zmienne `Income`, `WaistCirc` oraz `BMI` również zawierają braki, co zostało uwidocznione w tabeli statystyk zbiorczych, w kolumnie *N*, przedstawiającej liczbę obserwacji dla każdej z tych zmiennych. Sprawdzono, ile braków występuje dla każdej zmiennej oraz jaki stanowią one procent wszystkich obserwacji.

```{r message=FALSE, warning=FALSE, include=FALSE}
# zamiana pustych komórek na NA dla zmiennej `Marital`
dane_ms <- dane_ms %>%
  mutate(Marital = ifelse(as.character(Marital) == "",
                          NA, as.character(Marital)))
dane_ms$Marital <- as.factor(dane_ms$Marital)
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# wyświetlenie Tablicy 3.
kbl(miss_var_summary(dane_ms[c("Marital", "Income", "WaistCirc", "BMI")]),
    col.names = c("Zmienna", "Liczba braków", "Udział procentowy braków"),
    caption = "Podsumowanie brakujących danych dla wybranych zmiennych",
    booktabs = TRUE) %>% 
  kable_styling(latex_options = c("striped", "hold_position")) %>% 
  column_spec(2, width = "4.5cm") %>% 
  footnote(general = "Źródło: opracowanie własne na podstawie zbioru danych",
           general_title = "") 
```

  Najwięcej brakujących danych występuje w zmiennej `Marital` -- stanowią one 8,66% wszystkich obserwacji. Jest to odsetek przekraczający powszechnie akceptowany próg 5% braków. W pozostałych przypadkach braki stanowią mniej niż 5% wszystkich obserwacji. Dodatkowo, przeprowadzono analizę współwystępowania braków, uwzględniając zależności między brakującymi danymi w różnych zmiennych.

\begin{center}
Wykres 1: Rozkład braków oraz ich współwystępowania
\end{center}

```{r echo=FALSE, message=FALSE, warning=FALSE}
# tworzenie wykresu braku danych
gg_miss_upset(dane_ms[c("Marital", "Income", "WaistCirc", "BMI")], 
                            matrix.color = paleta[4], 
                            main.bar.color = paleta[4],
                            mainbar.y.label = "Liczba przypadków", 
                            sets.bar.color = paleta[5], 
                            sets.x.label = "Liczba braków")
```

Źródło: opracowanie własne na podstawie zbioru danych \newline

  Najczęściej występującymi brakami danych są pojedyncze braki w jednej z trzech zmiennych: stanie cywilnym, dochodach lub obwodzie talii. W zbiorze danych odnotowano 20 przypadków brakujących wartości jednocześnie dla zmiennych `BMI` i `WaistCirc`, a także 14 przypadków braków dotyczących jednocześnie zmiennych `Income` i `Marital`.

  W celu uzupełnienia brakujących danych zastosowano metodę imputacji wielokrotnej z wykorzystaniem procedury MICE. Metoda ta polega na wygenerowaniu kilku uzupełnionych wersji zbioru danych, w których wartości brakujące są zastępowane prognozowanymi wartościami opartymi na pozostałych zmiennych. Wygenerowanie kilku różnych zestawów pozwala na uwzględnienie niepewności związanej z brakami [@marszalek2023].

  Dla zmiennych ilościowych zastosowano technikę *PMM* (ang. *Predictive Mean Matching*). Polega ona na znalezieniu obserwacji z brakującą wartością, a następnie dopasowaniu jej do jednej z obserwacji nieposiadającej braków, która wykazuje najbardziej zbliżone wartości innych zmiennych objaśniających. Wartość brakująca zostaje zastąpiona wartością z dopasowanego rekordu, co pozwala zachować zgodność z rozkładem empirycznym zmiennej. Dla zmiennej jakościowej `Marital` użyto techniki *polyreg* (ang. *Polytomous logistic regression*), odpowiedniej dla zmiennych kategorycznych, nieuporządkowanych, o więcej niż dwóch wariantach [@mice].

  W procesie tworzenia zestawów imputowanych danych uwzględniono zmienną `Age`, która nie zawierała braków, aby poprawić predykcje brakujących wartości. Następnie porównano rozkłady zestawów imputowanych danych na wykresach oraz porównano statystyki zestawów: ich średnie, mediany i odchylenia standardowe.

```{r include=FALSE, results='hide'}
# wybór zmiennych do imputacji
zm_braki <- dane_ms[c("Age", "Marital", "Income", "WaistCirc", "BMI")]

# imputacja
imp_1 <- mice(zm_braki,
              m = 5,
              method = c("", "polyreg", "pmm", "pmm", "pmm"),
              seed = 123)
```

\begin{center}
Wykres 2: Rozkłady zestawów z imputowanymi danymi
\end{center}

```{r echo=FALSE}
# rozkłady zm. po imputacji
stripplot(imp_1, col = c(paleta[1], paleta[4]), pch = c(1, 20))[-1]
```

Źródło: opracowanie własne na podstawie zbioru danych \newline

```{r echo=FALSE, message=FALSE, warning=FALSE}
statystyki <- function(x) {
  c(Średnia = round(mean(x), 2), 
    Mediana = round(median(x), 2), 
    Odchylenie = round(sd(x), 2))
}

zmienne <- c("Income", "WaistCirc", "BMI")

tabela_finalna <- do.call(rbind, lapply(zmienne, function(zm) {
  oryg <- statystyki(dane_ms[[zm]][!is.na(dane_ms[[zm]])])
  zestawy <- sapply(1:5, function(i) {
    statystyki(complete(imp_1, i)[[zm]][is.na(dane_ms[[zm]])])
  })
  dane <- cbind(Zmienna = zm, 
                Zestaw = c("Oryginalne", paste("Zestaw", 1:5)),
                rbind(oryg, t(zestawy)))
  rownames(dane) <- NULL
  as.data.frame(dane)
}))

tabela_finalna[, 3:5] <- lapply(tabela_finalna[, 3:5], as.numeric)

# Wyświetlenie + ręczne paskowanie wierszy 1, 7, 13
kbl(tabela_finalna, 
    caption = "Statystyki imputacji dla Income, WaistCirc i BMI",
    booktabs = TRUE) %>%
  kable_styling(latex_options = "hold_position") %>%
  row_spec(c(1, 7, 13), background = "#F2F2F2") %>%
  column_spec(1:2, width = "4cm") %>% 
  footnote(general = "Źródło: opracowanie własne na podstawie zbioru danych", 
           general_title = "")
```

  Na podstawie analizy statystyk imputowanych zestawów danych stwierdzono, że zestaw 2 najtrafniej odwzorowuje rozkłady zmiennych oryginalnych. W przypadku dochodu zestaw ten ma statystyki nieco bardziej odchylone od statystyk oryginalnych danych, ale zbliżone wartości średnich, median oraz odchyleń standardowych dla obwodu w talii oraz BMI uzasadniają wybór tego zestawu do dalszych działań.

```{r include=FALSE}
# wybór kompletnego zestawu danych
imputed <- complete(imp_1, 2)

# podmiana zmiennych w głównym zbiorze
dane_ms[c("Age", "Marital", "Income", "WaistCirc", "BMI")] <- imputed
```

## Wizualizacje rozkładów

W celu lepszego zrozumienia struktury danych oraz identyfikacji potencjalnych różnic pomiędzy grupami pacjentów z rozpoznanym zespołem metabolicznym i bez niego, przeprowadzono wizualizację rozkładów zmiennych ilościowych. Dla każdej z tych zmiennych utworzono histogramy, które umożliwiają ocenę kształtu rozkładu oraz porównanie wartości pomiędzy dwiema grupami zdefiniowanymi przez zmienną `MetabolicSyndrome`. \newpage

\begin{center}
Wykres 3: Rozkłady zmiennych ilościowych
\end{center}

```{r echo=FALSE, message=FALSE, warning=FALSE}
ilosciowe <- c("Age", "Income", "WaistCirc", "BMI", "UrAlbCr",
               "UricAcid", "BloodGlucose", "HDL", "Triglycerides")
wykresy <- list()

for (i in seq_along(ilosciowe)) {
  zmienna <- ilosciowe[i]
  fill_col <- if (i %% 2 == 1) paleta[2] else paleta[4]
  line_col <- if (i %% 2 == 1) paleta[3] else paleta[5]

  wykresy[[i]] <- ggplot(dane_ms, aes_string(x = zmienna)) +
    geom_histogram(bins = 8,
                   fill = fill_col,
                   color = line_col, alpha = 0.9) +
    labs(title = zmienna, y = "Częstość") +
    theme_minimal() +
    theme(
      plot.title = element_text(hjust = 0.5),
      axis.title.x = element_blank()
    )
}

grid.arrange(grobs = wykresy, ncol = 3)
```

Źródło: opracowanie własne na podstawie zbioru danych \newline

  Histogramy zmiennych `BMI`, `UrAlbCr`, `BloodGlucose`, `HDL` oraz `Triglycerides` pokazują, że zmienne te zawierają wartości odstające, które mogą negatywnie wpływać na predykcje modelu. Zmienna `WaistCirc` również nie ma rozkładu normalnego, jednak jej zbiór wartości jest najbardziej "spójny" i nie zawiera punktów odstających o bardzo dużych wartościach. Rozkład wieku wskazuje, że w zbiorze znajduje się mniej więcej po tyle samo pacjentów (między 300 a 400 osób) w każdej grupie wiekowej, z wyjątkiem osób w wieku 20 lat, których jest kilkukrotnie mniej. W przypadku stosunku albumin do keratyniny w moczu niezbędne jest zlogarytmowanie zmiennej, ponieważ wartości odstające uniemożliwiają dokładną analizę rozkładu wartości.

\begin{center}
Wykres 4: Rozkłady zmiennych ilościowych z uwzględnieniem informacji o posiadaniu lub nieposiadaniu zespołu metabolicznego
\end{center}

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=8, fig.height=11}
# transformacja logarytmiczna zmiennej `UrAlbCr`
dane_ms$UrAlbCr <- log2(dane_ms$UrAlbCr)
plots <- list()

for (i in seq_along(ilosciowe)) {
  zmienna <- ilosciowe[i]
  
  plots[[i]] <- ggplot(dane_ms, aes(x = .data[[zmienna]],
                                    fill = factor(MetabolicSyndrome),
                                    color = factor(MetabolicSyndrome))) + 
    geom_histogram(position = "identity", alpha = 0.7) +
    scale_fill_manual(values = c(paleta[4], paleta[2])) +
    scale_color_manual(values = c(paleta[5], paleta[3])) +
    labs(title = zmienna, y = "Częstość") +
  guides(
    fill = guide_legend(title = "Zespół metaboliczny"),
    color = guide_legend(title = "Zespół metaboliczny")
  ) +
    theme_minimal() +
    theme(
      plot.title = element_text(hjust = 0.5),
      axis.title.x = element_blank(),
      legend.position = if (i == 4) c(0.72, 0.75) else "none"
    )
}

grid.arrange(grobs = plots[1:6], ncol = 2)
```

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=8, fig.height=7}
grid.arrange(grobs = plots[7:9], ncol = 2)
```

  Po stworzeniu oddzielnych wykresów częstości dla osób z zespołem metabolicznym oraz bez niego, zauważalna jest znaczna różnica w rozkładach niektórych zmiennych. Analizując histogram wieku osób zdrowych, można stwierdzić, że większość z nich to osoby poniżej 45. roku życia, a rozkład wieku w tej grupie przyjmuje charakter prawoskośny. Z kolei histogram osób z zespołem metabolicznym wykazuje bardziej wyrównany rozkład, z widoczną koncentracją przypadków w starszych grupach wiekowych, co może sugerować zwiększone ryzyko wystąpienia zespołu metabolicznego w późniejszym wieku. W przypadku zmiennych takich jak obwód talii oraz wskaźnik BMI, również dostrzega się przesunięcie wykresu częstości w prawo dla osób chorych. Podobny trend występuje w przypadku poziomu kwasu moczowego we krwi oraz glukozy. Natomiast rozkład zmiennej `HDL` wśród osób z zespołem metabolicznym charakteryzuje się niższymi wartościami HDL w porównaniu do osób zdrowych. Z kolei dochody nie wykazują istotnych różnic pomiędzy obiema grupami. Histogram zmiennej `UrAlbCr` po zastosowaniu transformacji logarytmicznej jest łatwiejszy do interpretacji. Z analizy wynika, że osoby chore częściej wykazują wyższe poziomy tej zmiennej w porównaniu do osób zdrowych.

## Analiza korelacji i zależności między zmiennymi

Analizę korelacji podzielono na trzy części: analizę korelacji między zmiennymi ilościowymi (z wykorzystaniem *korelacji Pearsona*), jakościowymi (*współczynnik kontyngencji V Cramera*) oraz między zmiennymi ilościowymi a jakościowymi.

\begin{center}
Wykres 5: Korelacje między zmiennymi ilościowymi
\end{center}

```{r echo=FALSE, message=FALSE, warning=FALSE}
model.matrix(~0+., data = dane_ms %>% select_if(is.numeric)) %>% 
  cor(use = "pairwise.complete.obs") %>% 
  ggcorrplot(title = "Wykres korelacji między zmiennymi",
             type = "upper",
             lab = TRUE, 
             colors = c(paleta[2], paleta[1], paleta[3],paleta[4]),
             lab_size = 2.5, 
             ggtheme = theme_classic)
```

  Między analizowanymi zmiennymi ilościowymi zaobserwowano słabe korelacje, z wyjątkiem pary `BMI` i `WaistCirc`. Ze względu na możliwość wystąpienia współliniowości, obwód w talii został wykluczony z dalszych analiz. Uznano, że wskaźnik `BMI` niesie więcej informacji, ponieważ uwzględnia zarówno masę ciała, jak i wzrost pacjenta.

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
jakosciowe <- c("Sex", "Marital", "Race", "Albuminuria")
kor.cramer <- matrix(NA, nrow = length(jakosciowe),
                     ncol = length(jakosciowe),
                     dimnames = list(jakosciowe, jakosciowe))

for (i in jakosciowe) {
  for (j in jakosciowe) {
    kor.cramer[i, j] <- round(assocstats(table(dane_ms[[i]], 
                                               dane_ms[[j]]))$cramer, 2)
  }}


kbl(kor.cramer,
    caption = "Korelacje między zmiennymi jakościowymi",
    booktabs = TRUE) %>%
  kable_styling(
    latex_options = c("hold_position"))
```

  Dla par zmiennych jakościowych obliczono współczynnik kontyngencji V Craméra. Przyjęto, że korelacja jest silna, gdy $V > 0{,}5$. W analizowanym zbiorze danych nie stwierdzono wartości przekraczających przyjęty próg.

  **Współczynnik korelacji punktowo-dwuseryjnej** pomiędzy zmienną ciągłą $X$ a zmienną dychotomiczną jest obliczany ze wzoru: $$r= \frac{(\overline{X} - \overline{X_{0}})\sqrt{\pi \cdot (1- \pi)}}{S_x}$$ Jest on równoważny wsp. korelacji Pearsona.

```{r echo=FALSE, message=FALSE, warning=FALSE}
dane_kor <- dane_ms %>%
  mutate(Race = as.numeric(factor(Race)) - 1, Sex = as.numeric(factor(Sex)) - 1,
         Marital = as.numeric(factor(Marital)) - 1, 
         Albuminuria = as.numeric(factor(Albuminuria)) - 1)

kor.pd <- round(cor(dane_kor[,c(1,4,6,7,9:13)], dane_kor[,c(2,3,5,8)]),2)

kbl(kor.pd,
    caption = "Korelacje między zmiennymi ilościowymi a jakościowymi",
    booktabs = TRUE) %>%
  kable_styling(
    latex_options = c("hold_position"))
```

  Między zmiennymi nie występują silne korelacje, z wyjątkiem jednej pary: `UrAlbCr` i `Albuminuria`. Obydwie zmienne związane są ze stężeniem albumin, jednak pierwsza z nich jest zmienną ilościową. Z tego powodu uznana została za zmienną zawierającą więcej informacji i tym samym tylko ona z tej pary uwzględniona zostanie w dalszych analizach. (jakieś lepsze wytłumacznie ale nwm ...?)

\newpage

# Budowa modeli

W celu otrzymania modelu z jak najlepszą zdolnością predykcyjną, przed przystąpieniem do jego budowy, oryginalne dane podzielone zostały na zbiór uczący i zbiór testowy. Modele budowane będą na zbiorze uczącym, który stanowi 70% całego zbioru danych, natomiast testowane będą na zbiorze testowym, który stanowi 30% oryginalnego zbioru. Taki podział pozwoli uniknąć przeuczenia modelu i możliwe będzie sprawdzenie jak radzi on sobie z nowymi danymi. W tabeli poniżej znajdują się proporcje wariantów zmiennej zależnej `MetabolicSyndrome` w pełnych danych i w danych uczących i testowych.

```{r echo=FALSE, message=FALSE, warning=FALSE}
set.seed(123)
n <- nrow(dane_ms)
l_losowe <- sample(c(1:n), round(0.7*n), replace = FALSE)
dane_u <- dane_ms[l_losowe,]
dane_t <- dane_ms[-l_losowe,]
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
tabela <- rbind(
  "dane" = as.numeric(prop.table(table(dane_ms$MetabolicSyndrome))),
  "zbiór uczący" = as.numeric(prop.table(table(dane_u$MetabolicSyndrome))),
  "zbiór testowy" = as.numeric(prop.table(table(dane_t$MetabolicSyndrome)))
)

colnames(tabela) <- names(tabela)
colnames(tabela) <- c(0, 1)

kbl(round(tabela, 3),
    caption = "Proporcje w zbiorach danych",
    booktabs = TRUE) %>%
  kable_styling(
    latex_options = c("hold_position")) %>%
  column_spec(c(1:2, 2:3), width = "4cm") %>% 
  footnote(general = "Źródło: opracowanie własne na podstawie zbioru danych", 
           general_title = "")
```

  Jak widać przy podziale na dwa zbiory, proporcje "odpowiedzi" zostały zachowane, zatem obydwa podzbiory dobrze reprezentują oryginalny zbiór danych.

  (...?) Jak zostało to określone wcześniej, zmienną objaśnianą jest zmienna dychotomiczna `MetabolicSyndrome`. Zmiennymi objaśniającymi będą natomiast wszystkie wymienione w poprzednim rodziale zmienne z wyjątkiem dwóch. Przy analizie korelacji zmienne `BMI` i `WaistCirc` oraz `Albuminuria` i `UrAlbCr` wykazały między sobą zbyt dużą korelację, w wyniku czego zmienne `WaistCirc` i `Albuminuria` wykluczone zostały z dalszych analiz. Do budowy modeli, jako zmienne objaśniające, wykorzystane zostaną zatem 3 zmienne jakościowe (`Sex`, `Marital`, `Race`) oraz 8 zmiennych ilościowych (`Age`, `Income`, `BMI`, `UrAlbCr`, `UricAcid`, `BloodGlucose`, `HDL`, `Triglycerides`).

## Estymacja modelu dwumianowego logitowego

  Estymowane będą modele dwumianowe logitowe ... jakiś opis co to

```{r echo=FALSE, message=FALSE, warning=FALSE}
model_logit0 <- glm(MetabolicSyndrome ~ Age + Sex + Marital + Race + Income + 
                      BMI + UrAlbCr + UricAcid + BloodGlucose + HDL + Triglycerides, 
                   data = dane_u, family = binomial)
# library("jtools")
# summ(model_logit0)
summary(model_logit0)
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
lrtest(model_logit0)
```

  Aby stwierdzić istotność wszystkich niezależnych zmiennych w modelu wykonany został test ilorazu wiarygodności. Test ten porównuje model zerowy (bez żadnych zmiennych) z modelem z dodatkowymi, w tym przypadku, 11 zmiennymi. Hipoteza zerowa dla testu zakłada brak związku między zmiennymi niezależnymi a zmienną zależną, a zatem test sprawdza czy dodatkowe zmienne wnoszą coś (...?) do modelu. P-wartość dla statystyki $\chi^2$ dla testu dla modelu `logit0` jest mniejsza niż przyjęty poziom istotności $\alpha = 0.05$. Odrzucamy zatem hipotezę zerową na rzecz hipotezy alternatywnej, tym samym stwierdzając, że dodatkowe zmienne istotnie wpływają na zmienną zależną.

```{r echo=FALSE, message=FALSE, warning=FALSE}
vif(model_logit0)
```

  opis vif, wszystko spoko

  Z podsumowania modelu natomiast, możemy odczytać, że nie wszystkie zmienne (oddzielnie) są istotne przy jego budowie. P-wartości dla statystyki $z$ wyższe od poziomu istotności $\alpha = 0.1$ widoczne są dla zmiennych `Race` i `Income`, co wskazuje na ich nieistotność. Niższą istotność wykazują także zmienne `Marital`, `UrAlbCr` oraz `UricAcid`. W takim wypadku wyestymowany zostanie nowy model logitowy uwzględniający wcześniej wykorzystane zmienne z wyjątkiem zmiennych zupełnie nieistotnych (`Race`, `Income`).

```{r echo=FALSE, message=FALSE, warning=FALSE}
model_logit1 <- glm(MetabolicSyndrome ~ Age + Sex + Marital + BMI + UrAlbCr + 
                      UricAcid + BloodGlucose + HDL + Triglycerides, 
                   data = dane_u, family = binomial)
summary(model_logit1)
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
lrtest(model_logit1)
```

  Dla powyższego modelu, również wykonany został test ilorazu wiarygodności. P-wartość dla statystyki $\chi^2$ jest mniejsza od przyjętego poziomu istotności ($\alpha = 0.05$), co także w tym przypadku pozwala na odrzucenie hipotezy zerowej, mówiącej o nieistotności wszystkich zmiennych w modelu.

```{r echo=FALSE, message=FALSE, warning=FALSE}
vif(model_logit1)
```

  Wartości VIF też blisko 1 spoko. (...?)

  Podsumowanie modelu `logit1` nie wskazuje żadnych zupełnie nieistotnych zmiennych. Można jednak zauważyć, że warianty zmiennej `Marital` wykazują różną istotność. W szczegolności p-wartość dla wariantu `Marital: Married` jest wyższa od najwyższego poziomu istotności (równego 0.1), wskazując na jego nieistotność. Inne warianty istotne są na poziomach 0.05 i 0.1, co jest wynikiem gorszym niż dla pozostałych zmiennych. Warto także odnotować, że p-wartości dla zmiennych `UrAlbCr` i `UricAcid` zmieniły się minimalnie, co, po usunięciu nieistotnych zmiennych, nie poprawiło mocno ich istotności. Aby sprawdzić czy zmienna `Marital` faktycznie nie wpływa znacznie na zmienną objaśnianą, wykonany zostanie nowy model, poprzez usnięcie jej ze zmiennych objaśniających.

```{r echo=FALSE, message=FALSE, warning=FALSE}
model_logit2 <- glm(MetabolicSyndrome ~ Age + Sex + BMI + UrAlbCr + UricAcid + 
                      BloodGlucose + HDL + Triglycerides, 
                   data = dane_u, family = binomial)
summary(model_logit2)
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
lrtest(model_logit2)
```

  git

```{r echo=FALSE, message=FALSE, warning=FALSE}
vif(model_logit2)
```

  vif -\> git

  Z podsumowania modelu wynika, że wszystkie zmienne objaśniające są istotne, przy czym istotność zmiennych `UrAlbCr` i `UricAcid` nadal jest na poziomie ok. 0.05. (nie wiem czy można tak pisać ...?) Co więcej usunięcie zmiennej `Marital` z modelu podwyższyło wartość AIC z 1206 (model `logit1`) na 1214, przy czym warto zauważyć, że jest to także wartość wyższa od AIC dla modelu `logit0` (modelu ze wszystkimi zmiennymi objasniającymi), która była równa 1213. Zdaje się zatem, że usuwanie kolejnych zmiennych może mieć podobny efekt i również jedynie pogorszać wartości AIC dla modelu.

## Estymacja modelu probitowego

  Jakiś opis I guess

```{r echo=FALSE, message=FALSE, warning=FALSE}
model_probit0 <- glm(MetabolicSyndrome ~ Age + Sex + Marital + Race + Income + BMI + 
                 UrAlbCr + UricAcid + BloodGlucose + HDL + Triglycerides, 
               data = dane_u, family = binomial(link=probit))
summary(model_probit0)
```

```{r}
lrtest(model_probit0)
```

  spoko

```{r}
vif(model_probit0)
```

  vif -\> spoko

  Tak jak w przypadku modelu `logit0`, zmienne `Race` i `Income` zdają się być nieistotne, p-wartości dla statystyki $z$ są dużo wyższe niż najwyższy z poziomów istotności ($\alpha = 0.1$). Co więcej w przypadku zmiennej `Marital` możemy zaobserwować podobną sytuację, jak dla modeli logitowych. Dwa warianty tej zmiennej także nie są istotne. Ponieważ w poprzednim przypadku usunięcie tej zmiennej pogorszyło wartość AIC, w pierwszej kolejności powstanie model bez zmiennych zupełnie nieistotnych (`Race`,`Income`). (...coś więcej?)

```{r echo=FALSE, message=FALSE, warning=FALSE}
model_probit1 <- glm(MetabolicSyndrome ~ Age + Sex + Marital + BMI + UrAlbCr + 
                      UricAcid + BloodGlucose + HDL + Triglycerides, 
                   data = dane_u, family = binomial(link=probit))
summary(model_probit1)
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# model_probit2 <- glm(MetabolicSyndrome ~ Age + Sex + BMI + UrAlbCr + UricAcid + 
#                  BloodGlucose + HDL + Triglycerides, 
#                data = dane_u, family = binomial(link=probit))
# summary(model_probit2)
```

## Estymacja modelu logitowego z interakcjami

```{r}
model1 <- glm(MetabolicSyndrome ~ Age*BloodGlucose + Sex + BMI + UrAlbCr + UricAcid + 
                      HDL + Triglycerides,
                  data = dane_u, family = binomial)
summary(model1)
```

```{r}
model2 <- glm(MetabolicSyndrome ~ Age*BloodGlucose + Sex + BMI + UrAlbCr + UricAcid + 
                      HDL + Triglycerides + Sex:HDL,
                  data = dane_u, family = binomial)
summary(model2)
```

```{r}
model3 <- glm(MetabolicSyndrome ~ Age*BloodGlucose + Sex + BMI + UrAlbCr + UricAcid + 
                      HDL + Triglycerides + Sex:HDL + Age:UricAcid,
                  data = dane_u, family = binomial)
summary(model3)
```

```{r}
model4 <- glm(MetabolicSyndrome ~ Age*BloodGlucose + Sex + BMI + UrAlbCr + UricAcid + 
                      HDL + Triglycerides + Sex:HDL + Age:UricAcid + HDL:Triglycerides,
                  data = dane_u, family = binomial)
summary(model4)
```

ISTOTNOŚĆ: Age*BloodGlucose -\> tak (zwykle pogarsza się z wiekiem) + Sex*HDL -\> tak (kobiety mają wyższe) + Age*UricAcid -\> tak (zwykle zwiększa się z wiekiem) + HDL*Triglycerides -\> tak, ale może już być przeuczony i zbyt skomplikowany UricAcid*BMI -\> nie Sex*BMI -\> nie UricAcid*BloodGlucose -\> nie BMI*Triglycerides -\> nie BMI\*BloodGlucose -\> nie nie wiem czy jeszcze jakieś

ostatni ma niby najlepsze AIC ze wszystkich modeli (sprawdzone ze step)

NOTATKI: OPISY TO WORK IN PROGRESS modele logitowe: usuniecie najpierw income pozniej race nie ma znaczenia wiec usunelam od razu obydwa na raz a drugi model z usunieciem marital nie jestem pewna, aic wychodzi wieksze ale nie do konca jest istotne, wiec zostawilam do testow usuniecie tych zmiennych ktore sa mniej istotne w sumie tez nie ma sensu bo aic znowu wieksze i nie ma jakichs dobrych powodow wazne: step(logit0) daje model logit1, wiec to usuniecie marital i w logitowym i probitowym moze nie miec az takiego sensu, chociaz imo w logitowym mozna zostawic tak zeby sprawdzic modele probitowe: tylko jeden dodatkowy, z tym marital wyszlo podobnie jak z logitowym wiec tu juz nie dodawalam kolejnego z interakcjami: opis wyżej, wzielam interakcje takie ktore maja sens ogólnie, sprawdziłam tez wszystkie interakcje (miedzy wszystkimi zmiennymi z funkcja step) i byly takie ktore byly istotne ale troche bezsensowne wiec nie wiem

-   wszystkie byly sprawdzone z funkcja step()

\newpage

# Ocena modeli i interpretacja modelu wynikowego

## Ocena dopasowania modeli

## Ocena jakości predykcji

## Interpretacja modelu wynikowego

\newpage

# Podsumowanie i wnioski

------------------------------------------------------------------------

\newpage

# Bibliografia
